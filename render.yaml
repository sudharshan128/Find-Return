# Render Blueprint — Trust-Based Lost & Found Platform
# Deploy: connect repo in Render dashboard → "New Blueprint" → point to this file

services:

  # ── Backend: Node.js / Express API ──────────────────────────
  - type: web
    name: find-return-backend
    env: node
    region: singapore
    plan: starter
    buildCommand: cd backend/nodejs && npm install && npm run build
    startCommand: cd backend/nodejs && node dist/server.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      # Render injects PORT automatically — do NOT hardcode it here
      - key: SUPABASE_URL
        sync: false          # paste in Render dashboard → Environment
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false          # CRITICAL — never commit this value
      - key: SUPABASE_JWT_SECRET
        sync: false
      # CORS: tell the backend the live frontend URL
      - key: FRONTEND_URL
        fromService:
          type: web
          name: find-return-frontend
          property: url
      - key: FRONTEND_ORIGIN
        fromService:
          type: web
          name: find-return-frontend
          property: url
      - key: RATE_LIMIT_WINDOW_MS
        value: "900000"
      - key: RATE_LIMIT_MAX_REQUESTS
        value: "100"
      - key: ADMIN_RATE_LIMIT_MAX_REQUESTS
        value: "50"
      - key: TOTP_WINDOW
        value: "2"

  # ── Frontend: React / Vite static site ──────────────────────
  - type: web
    name: find-return-frontend
    env: static
    region: singapore
    buildCommand: cd frontend && npm install && npm run build
    staticPublishPath: frontend/dist
    # SPA fallback — all routes serve index.html
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_SUPABASE_URL
        sync: false          # paste in Render dashboard → Environment
      - key: VITE_SUPABASE_ANON_KEY
        sync: false
      # ⚠️  MUST be VITE_BACKEND_URL — this is what the frontend code reads
      - key: VITE_BACKEND_URL
        fromService:
          type: web
          name: find-return-backend
          property: url
